<!DOCTYPE html>
<html lang="en">
<head>
  <title>Hippocampal Voltage Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 30px; background-color: #f7f7f7; }
    #slider { width: 100%; margin-top: 20px; }
    #plot { height: 600px; margin-bottom: 20px; }
    select { font-size: 16px; padding: 5px; }
    h2 { margin-bottom: 10px; }
  </style>
</head>
<body>

<h2>ðŸ§  Hippocampal Voltage Explorer</h2>

<label for="subjectSelect">Select subject:</label>
<select id="subjectSelect">
  <option value="P1">P1</option>
  <option value="P2">P2</option>
  <option value="P3">P3</option>
  <option value="P4">P4</option>
  <option value="P5a">P5a</option>
  <option value="P5b">P5b</option>
  <option value="P6">P6</option>
</select>

<div id="plot"></div>
<input type="range" id="slider" min="0" max="1" value="0">

<script>
let currentCamera = null;

const subjectURLs = {
  "P1": "https://firebasestorage.googleapis.com/v0/b/theoriesofconsciousness.appspot.com/o/P1.json?alt=media&token=bb95893b-b252-4951-8e94-71e8ffe43253",
  "P2": "https://firebasestorage.googleapis.com/v0/b/theoriesofconsciousness.appspot.com/o/P2.json?alt=media&token=23fa463a-5ed2-408b-b705-91988ab3969b",
  "P3": "https://firebasestorage.googleapis.com/v0/b/theoriesofconsciousness.appspot.com/o/P3.json?alt=media&token=44a89613-eb6a-4c87-8217-4c5c50fc803f",
  "P4": "https://firebasestorage.googleapis.com/v0/b/theoriesofconsciousness.appspot.com/o/P4.json?alt=media&token=6f1e398d-cffe-40d0-89b6-b8df63de2927",
  "P5a": "https://firebasestorage.googleapis.com/v0/b/theoriesofconsciousness.appspot.com/o/P5a.json?alt=media&token=9cb28213-9150-4995-93b0-bfb50a9b79e1",
  "P5b": "https://firebasestorage.googleapis.com/v0/b/theoriesofconsciousness.appspot.com/o/P5b.json?alt=media&token=51338ae4-9185-49b5-8c56-f6736757786f",
  "P6": "https://firebasestorage.googleapis.com/v0/b/theoriesofconsciousness.appspot.com/o/P6.json?alt=media&token=4f64fcdf-cea1-4c88-bb57-279e4369a94aa"
};

let data = null;
let currentFrame = 0;
const slider = document.getElementById("slider");
const subjectSelect = document.getElementById("subjectSelect");

subjectSelect.addEventListener("change", () => {
  const subjKey = subjectSelect.value;
  loadSubject(subjectURLs[subjKey]);
});

slider.addEventListener("input", () => {
  if (data) {
    currentFrame = parseInt(slider.value);
    drawFrame(currentFrame);
  }
});

document.addEventListener("keydown", (event) => {
  if (!data) return;
  const step = event.shiftKey ? 20 : 1;
  if (event.key === "ArrowRight") {
    currentFrame = Math.min(currentFrame + step, data.t.length - 1);
    slider.value = currentFrame;
    drawFrame(currentFrame);
  } else if (event.key === "ArrowLeft") {
    currentFrame = Math.max(currentFrame - step, 0);
    slider.value = currentFrame;
    drawFrame(currentFrame);
  }
});

function loadSubject(url) {
  fetch(url)
    .then(response => response.json())
    .then(json => {
      data = json;
      slider.max = data.t.length - 1;
      slider.value = 0;
      currentFrame = 0;
      drawFrame(0);
    });
}

function drawFrame(tIndex) {
  const voltages = data.z.map(ch => ch[tIndex]);

  const trace = {
    x: data.x,
    y: data.y,
    z: voltages,
    mode: 'markers',
    type: 'scatter3d',
    marker: {
      size: 6,
      color: voltages,
      colorscale: 'Jet',
      cmin: -1000,
      cmax: 1000,
      colorbar: { title: 'Î¼V' }
    }
  };

  const lines = {
    x: [], y: [], z: [],
    mode: 'lines',
    type: 'scatter3d',
    line: { color: 'gray', width: 1 },
    hoverinfo: 'skip'
  };

  for (let i = 0; i < data.x.length; i++) {
    lines.x.push(data.x[i], data.x[i], null);
    lines.y.push(data.y[i], data.y[i], null);
    lines.z.push(0, voltages[i], null);
  }

  const columnStripes = {
    type: 'mesh3d',
    x: [], y: [], z: [],
    i: [], j: [], k: [],
    facecolor: [],
    showscale: false,
    opacity: 0.15,
    hoverinfo: 'skip'
  };

  const stripeColors = ['#d3d3d3', '#a9a9a9'];
  let vertexCount = 0;

  for (let col = 1; col <= 8; col++) {
    const colorIndex = col % 2;
    const x0 = col - 0.5, x1 = col + 0.5;
    const y0 = 0.5, y1 = 4.5, z = 0;

    columnStripes.x.push(x0, x1, x1, x0);
    columnStripes.y.push(y0, y0, y1, y1);
    columnStripes.z.push(z, z, z, z);

    columnStripes.i.push(vertexCount);
    columnStripes.j.push(vertexCount + 1);
    columnStripes.k.push(vertexCount + 2);

    columnStripes.i.push(vertexCount);
    columnStripes.j.push(vertexCount + 2);
    columnStripes.k.push(vertexCount + 3);

    columnStripes.facecolor.push(stripeColors[colorIndex]);
    columnStripes.facecolor.push(stripeColors[colorIndex]);

    vertexCount += 4;
  }

  const labelTrace = {
    x: [1, 8, 4.5, 4.5],
    y: [2, 2, 1, 4],
    z: [3000, 3000, 3000, 3000],
    mode: 'text',
    type: 'scatter3d',
    text: ['SEPTAL', 'TEMPORAL', 'INFERIOR', 'SUPERIOR'],
    textposition: 'top center',
    textfont: { size: 14, color: 'black' },
    hoverinfo: 'none'
  };

  const layout = {
    title: `Time = ${data.t[tIndex].toFixed(3)} s`,
    scene: {
      xaxis: { title: '', range: [0.5, 8.5] },
      yaxis: { title: '', range: [0.5, 4.5] },
      zaxis: { title: 'Voltage (Î¼V)', range: [-3000, 3000] },
      ...(currentCamera && { camera: currentCamera }) // Only apply if exists
    },
    margin: { t: 50 }
  };

  Plotly.react('plot', [columnStripes, lines, trace, labelTrace], layout).then(() => {
    const plotDiv = document.getElementById('plot');
    if (!drawFrame.listenerAdded) {
      plotDiv.on('plotly_relayout', (eventData) => {
        if (eventData['scene.camera']) {
          currentCamera = eventData['scene.camera'];
        }
      });
      drawFrame.listenerAdded = true;
    }
  });
}

// Load default subject
loadSubject(subjectURLs["P1"]);
</script>

</body>
</html>
